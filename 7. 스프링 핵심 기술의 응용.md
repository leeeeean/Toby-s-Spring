# 7장. 스프링 핵심 기술의 응용

## 7.1 SQL과 DAO의 분리

어떤 이유든지 SQL 변경이 필요한 상황이 발생하면 SQL을 담고 있는 DAO 코드가 수정될 수 밖에 없다
그러므로 SQL과 DAO를 분리해야 한다

### XML 설정을 이용한 분리

SQL을 스프링의 XML 설정파일로 빼내는 것
SQL은 문자열로 되어있으므로 이를 설정파일에 프로퍼티 값으로 정의해서 DAO에 주입해 줄 수 있음

* **개별 SQL 프로퍼티 방식**
  * 변수와 수정자 메소드를 만들고 프로퍼티를 추가한다
* **SQL 맵 프로퍼티 방식**
  * SQL이 많을 경우에 사용
  * SQL을 하나의 컬렉션에 담는 방법 사용
  * 하나의 맵 변수와 수정자 메소드를 만들고 프로퍼티에 맵을 추가한다



### SQL 제공 서비스

SQL과 DI 설정정보가 섞여있으면 보기에도 지저분하고 관리하기에도 좋지 않음
SQL의 경우 꼭 XML에 담아 둘 필요도 없다
또 다양한 곳에서 SQL을 읽어오게 될 수도 있다
그러므로 독립적인 SQL 제공 서비스가 필요하다

* **SQL 서비스 인터페이스**

  ```java
  public interface SqlService {
    String getSql(String key) throws SqlRetrievalFailureExceptions;
  }
  ```

* **스프링 설정을 사용하는 단순 SQL 서비스**
  * 코드와 설정만 놓고 보자면 앞서 사용했던 방법과 별반 다를게 없어 보일 수 있다
  * 하지만 이제 모든 DAO는 SQL을 어디에 저장해두고 가져오는지에 대해서는 전혀 신경 쓰지 않아도 된다
  * 구체적인 구현 방법과 기술에 상관 없이 SqlService 인터페이스 타입의 빈을 DI 받아서 필요한 SQL을 가져다 쓰기만 하면 된다



## 7.2 인터페이스 분리와 자기참조 빈

### XML 파일 매핑

검색용 키와 SQL 문장 두 가지를 담을 수 있는 간단한 XML 문서를 설계해보고, 이 XML 파일에서 SQL을 읽어뒀다가 DAO에게 제공해주는 SQL 서비스 구현 클래스를 만들어 본다

* **JAXB**
  * XML 문서정보를 거의 동일한 구조의 오브젝트로 직접 매핑해줌
  * XML 문서의 구조를 정의한 스키마를 이용해서 매핑힐 오브젝트의 클래스까지 자동으로 만들어주는 컴파일러도 제공
  * 스키마 컴파일러를 통해 자동생성된 오브젝트에는 매핑정보가 애노테이션으로 담겨있음
* **언마샬링**
  * 언마샬링 : XML 문서를 읽어서 자바의 오브젝트로 변환하는 것
  * 마샬링 : 바인딩 오브젝트를 XML 문서로 변환하는 것
  * 직렬화 : 자바 오브젝트를 바이트 스트림으로 바꾸는 것



### 빈의 초기화 작업

* 개선해야 할 점
  * 생성자에서 예외가 발생할 수도 있는 복잡한 초기화 잡ㄱ업을 다루는 것은 좋지 않음
    * 초기 상태를 가진 오브젝트를 만들어 놓고 별도의 초기화 메소드를 사용하는 방법이 바람직 
  * 읽어들일 파일의 위치와 이름이 코드에 고정되어 있다는 점
    * 외부에서 DI로 설정해줄 수 있게 만들어야 함
* @PostConstruct
  * 스프링은 이 애노테이션을 빈 오브젝트의 초기화 메소드를 지정하는데 사용
  * 초기화 작업을 수할 메소드에 @PostConstruct 를 부여해주면 스프링은 XmlSqlService 클래스로 등록된 빈의 오브젝트를 생성하고 DI 작업을 마친 뒤에 @PostConstruct가 붙은 메소드를 자동으로 실행해줌
  * 생성자와는 달리 프로퍼티까지 모두 준비된 후에 실행된다는 면에서 매우 유용



### 변화를 위한 준비: 인터페이스 분리

* **책임에 따른 인터페이스 정의**
  * 분리 가능한 관심사 구분
    * SQL 정보를 외부의 리소스로부터 읽어오는 것
    * 읽어온 SQL을 보관해두고 있다가 필요할 때 제공해주는 것
    * 서비스를 위해 한 번 가져오 SQL을 필요에 따라 수정할 수 있게 하는 것
      * 전략 패턴을 적용해 별도의 오브젝트 분리 필요
* **SqlRegistry 인터페이스**
  * sql 등록
  * sql 검색
* **SqlReader 인터페이스**
  * sql 읽어오기



### 자기참조 빈으로 시작하기

* **다중 인터페이스 구현과 간접 참조**
  * 세분화된 책임을 정의한 인터페이스들을 구현한다
  * 같은 클래스의 코드이지만 책임이 다른 코드는 직접 접근 하지 않고 인터페이스를 통해 간접적으로 접근한다
* **자기참조 빈 설정**
  * ref 항목에 자기 자신을 넣어 준다



### 디폴트 의존관계

* **디폴트 의존관계를 갖는 빈 만들기**
  * 특정 의존 오브젝트가 대부분의 환경에서 거의 디폴트라고 해도 좋을 만큼 기본적으로 사용될 가능성이 있다면, 디폴트 의존관계를 갖는 빈을 만드는 것을 고려해볼 필요가 있다
  * 디폴트 의존관계 : 외부에서 DI 받지 않는 경우 기본적으로 자동 적용되는 의존관계를 말함
    * 디폴트로 젛용하고 싶은 의존 오브젝트를 생성자에 넣어줌
    * 빈 설정이 없어짐



​		

